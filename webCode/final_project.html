<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="style.css" />
    <title>WebSocket demo</title>
</head>
    <body>
        <div id="page">
		
            <div id="header">
                <h1>This is your first webpage!</h1>
                <h2>Display a variable from your Raspberry to websocket</h2>
                
            </div>

            <div id="input">
                <h2>This is the Output division</h2>
                <input id='setpoint' type="range" class="input-knob" 
                 min="0" max="120" style="width:300px;"/>
                <p style="font-size: large;">Setpoint value:
                    <output id="value"></output>
                </p>
                <br>
                <h2>This is the Input division</h2>
                <input id='setpoint_in' type="range" class="input-knob" 
                 min="0" max="120" style="width:300px;"/>
                <p style="font-size: large;">Setpoint value:
                    <output id="value_in"></output>
                </p>
            </div>
            <script type="text/javascript" src="mqttws31.js"></script>
            <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
            <script>
                var client_Speed = new Paho.Client("10.5.3.101", 15677, "speed");
                client_Speed.onConnectionLost = onConnectionLost_speed;
                client_Speed.onMessageArrived = onMessageArrived_speed;
                client_Speed.connect({onSuccess:onConnect_speed, cleanSession:true, keepAliveInterval:10});

                function onConnect_speed() {
                    // Once a connection has been made, make a subscription and send a message.
                    console.log("onConnect_speed");
                    client_Speed.subscribe("data/speed");
                };
                function onConnectionLost_speed(responseObject) {
                    if (responseObject.errorCode !== 0){
                        console.log("onConnectionLost_speed:"+responseObject.errorMessage);
                    }
                };
                function onMessageArrived_speed(message) {
                    document.getElementById("value").value = message.payloadString;
                    //console.log("onMessageArrived_speed:"+message.payloadString);
                    addData(message.payloadString, 0)
                };

                var client_reference = new Paho.Client("10.5.3.101", 15677, "reference");
                client_reference.onConnectionLost = onConnectionLost_reference;
                client_reference.onMessageArrived = onMessageArrived_reference;
                client_reference.connect({onSuccess:onConnect_reference, cleanSession:true, keepAliveInterval:10});

                function onConnect_reference() {
                    // Once a connection has been made, make a subscription and send a message.
                    console.log("onConnect_reference");
                    client_reference.subscribe("data/reference");
                };
                function onConnectionLost_reference(responseObject) {
                    if (responseObject.errorCode !== 0){
                        console.log("onConnectionLost_reference:"+responseObject.errorMessage);
                    }
                };
                function onMessageArrived_reference(message) {
                    document.getElementById("setpoint").value = message.payloadString;
                    //console.log("onMessageArrived_reference:"+message.payloadString);
                    addData(message.payloadString, 1)
                };

                var client_send = new Paho.Client("10.5.3.101", 15677, "send");
                client_send.onConnectionLost = onConnectionLost_send;
                client_send.connect({onSuccess:onConnect_send, cleanSession:true, keepAliveInterval:10});

                async function onConnect_send() {
                    while (true){
                        var msg = new Paho.Message(document.getElementById("setpoint_in").value);
                        document.getElementById("value_in").value = document.getElementById("setpoint_in").value
                        console.log("onMessageArrived_reference:"+msg.payloadString);
                        msg.destinationName="data/setpoint";
                        client_send.send(msg);
                        await new Promise(resolve => setTimeout(resolve, 1220));
                        
                    }
                };
                function onConnectionLost_send(responseObject) {
                    if (responseObject.errorCode !== 0){
                        console.log("onConnectionLost_time:"+responseObject.errorMessage);
                    }
                };
                
            </script>
            <h1>Dynamic Chart</h1>
            <canvas id="myChart" stile="box-sizing: border-box; height: 376px; width: 753px; display: contents !important"></canvas>
            <script src="chart_motor.js"></script>
        </div>
    </body>
</html>

